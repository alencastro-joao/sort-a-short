<!DOCTYPE html>
<html lang="pt-br">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{META_TITLE}}</title>
    <link rel="icon" href="/icon.png" type="image/png">

    <script src="https://unpkg.com/react@18/umd/react.development.js"></script>
    <script src="https://unpkg.com/react-dom@18/umd/react-dom.development.js"></script>
    <script src="https://unpkg.com/@babel/standalone/babel.min.js"></script>
    <script src="https://cdn.dashjs.org/latest/dash.all.min.js"></script>
    
    <link href="https://fonts.googleapis.com/css2?family=Space+Mono:ital,wght@0,400;0,700;1,400&display=swap" rel="stylesheet">

    <style>
        :root { --bg-color: #050505; --text: #e0e0e0; --highlight: #cc0000; --glass: rgba(15, 15, 15, 0.98); --border: #333; --success: #00e676; --pink: #e91e63; }
        * { box-sizing: border-box; }
        body { font-family: 'Space Mono', monospace; background-color: var(--bg-color); color: var(--text); margin: 0; height: 100vh; overflow: hidden; display: flex; justify-content: center; align-items: center; }
        ::-webkit-scrollbar { width: 4px; }
        ::-webkit-scrollbar-track { background: #000; }
        ::-webkit-scrollbar-thumb { background: #333; border-radius: 2px; }
        ::-webkit-scrollbar-thumb:hover { background: var(--highlight); }

        .video-background { position: fixed; top: 0; left: 0; width: 100%; height: 100%; z-index: 0; background: #000; transition: all 0.8s ease; }
        .video-background.dimmed { filter: brightness(0.2) blur(10px) grayscale(100%); transform: scale(1.05); }
        .video-background.active { z-index: 50; filter: brightness(1) blur(0) grayscale(0%); transform: scale(1); }
        video { width: 100%; height: 100%; object-fit: contain; outline: none; }
        
        .ui-layer { position: absolute; top: 0; left: 0; width: 100%; height: 100%; z-index: 10; display: flex; justify-content: center; align-items: center; pointer-events: none; }
        .sort-container { text-align: center; pointer-events: auto; z-index: 20; }
        .big-title { font-size: 3.5rem; margin-bottom: 20px; letter-spacing: 8px; text-transform: uppercase; border-bottom: 1px solid #444; display: inline-block; color: #fff; }
        
        .auth-modal { position: fixed; top: 0; left: 0; width: 100%; height: 100%; background: rgba(0,0,0,0.95); z-index: 200; display: flex; justify-content: center; align-items: center; backdrop-filter: blur(0px); padding: 20px; }
        .auth-box { background: #0a0a0a; border: 1px solid #333; padding: 40px; width: 400px; text-align: center; box-shadow: 0 0 20px rgba(0,0,0,0.5); animation: fadeIn 0.3s ease; max-height: 90vh; overflow-y: auto; position: relative; }
        .profile-box { width: 800px; max-width: 100%; text-align: left; display: flex; flex-direction: column; justify-content: flex-start; padding: 40px; }
        .movie-card { background: var(--glass); border: 1px solid var(--border); padding: 50px; max-width: 600px; width: 90%; text-align: left; pointer-events: auto; box-shadow: 0 10px 30px rgba(0,0,0,0.5); animation: slideUp 0.5s ease-out; }
        
        .btn-main { background: #fff; color: #000; border: 1px solid #fff; padding: 15px 30px; font-family: 'Space Mono'; font-weight: bold; font-size: 0.9rem; cursor: pointer; text-transform: uppercase; letter-spacing: 2px; transition: background-color 0.2s, color 0.2s; width: 100%; }
        .btn-main:hover { background: #ccc; color: #000; }
        .btn-sort { background: transparent; color: #fff; border: 1px solid #fff; padding: 20px 60px; font-size: 1rem; margin-top: 20px; }
        .btn-sort:hover { background: rgba(255,255,255,0.1); }
        
        .btn-back-corner { position: fixed; top: 70px; left: 30px; z-index: 100; color: #888; border: 1px solid #333; padding: 8px 15px; cursor: pointer; pointer-events: auto; font-family: 'Space Mono'; text-transform: uppercase; transition: 0.2s; background: #000; font-size: 0.8rem; }
        .btn-back-corner:hover { color: var(--highlight); border-color: var(--highlight); }
        
        .btn-secondary { padding: 12px; fontSize: 0.8rem; background: #000; color: #888; border: 1px solid #333; cursor: pointer; width: 100%; transition: 0.2s; font-family: 'Space Mono'; text-transform: uppercase; }
        .btn-secondary:hover { background: var(--highlight); color: #fff; border-color: var(--highlight); }
        .btn-close-box { width: 35px; height: 35px; background: #000; border: 1px solid #333; color: #888; display: flex; justify-content: center; align-items: center; cursor: pointer; font-family: 'Space Mono'; font-size: 1.2rem; transition: 0.2s; z-index: 10; flex-shrink: 0; }
        .btn-close-absolute { position: absolute; top: 15px; left: 15px; }
        .btn-close-box:hover { border-color: var(--highlight); color: var(--highlight); background: #111; }

        .btn-finish { position: fixed; top: 30px; right: 30px; z-index: 100; background: rgba(0,0,0,0.7); border: 1px solid #666; color: #fff; padding: 10px 20px; cursor: pointer; text-transform: uppercase; font-family: 'Space Mono'; font-size: 0.8rem; pointer-events: auto; transition: 0.2s; }
        .btn-finish:hover { border-color: var(--highlight); color: var(--highlight); background: #000; }

        .user-bar { position: fixed; top: 30px; right: 30px; z-index: 100; display: flex; gap: 15px; pointer-events: auto; align-items: center; }
        .btn-login { background: transparent; border: 1px solid var(--highlight); color: var(--highlight); padding: 8px 15px; cursor: pointer; font-family: 'Space Mono'; font-size: 0.75rem; transition: 0.2s; }
        .btn-login:hover { background: var(--highlight); color: #fff; }
        .user-info { color: var(--highlight); font-size: 0.8rem; font-weight: bold; cursor: pointer; letter-spacing: 1px; transition: 0.2s; text-decoration: underline; display: flex; align-items: center; gap: 10px; }
        .user-info:hover { color: #fff; }
        
        .energy-fixed { position: fixed; top: 30px; left: 30px; z-index: 100; display: flex; align-items: center; gap: 4px; pointer-events: none; }
        .energy-bar { width: 10px; height: 18px; background: #222; border: 1px solid #444; transform: skewX(-15deg); transition: 0.3s; box-shadow: inset 0 0 2px #000; }
        .energy-bar.active { background: var(--highlight); border-color: var(--highlight); box-shadow: 0 0 8px var(--highlight); }
        .energy-timer { font-size: 0.7rem; color: #666; margin-left: 8px; font-family: monospace; text-shadow: 0 1px 2px #000; }

        .auth-input { width: 100%; padding: 12px; margin-bottom: 15px; background: #111; border: 1px solid #333; color: #fff; font-family: 'Space Mono'; outline: none; transition: 0.2s; font-size: 0.9rem; }
        .auth-input:focus { border-color: var(--highlight); background: #000; }
        .auth-link { color: #666; font-size: 0.75rem; cursor: pointer; text-decoration: underline; margin-top: 15px; display: block; transition: 0.2s; }
        .auth-link:hover { color: var(--highlight); }
        .auth-error { color: var(--highlight); font-size: 0.75rem; margin-bottom: 15px; border: 1px solid var(--highlight); padding: 10px; background: rgba(50,0,0,0.1); }
        
        .input-wrapper { position: relative; width: 100%; }
        .btn-toggle-pass { position: absolute; right: 10px; top: 50%; transform: translateY(-50%); background: none; border: none; color: #666; cursor: pointer; font-size: 0.65rem; padding: 5px; font-family: 'Space Mono', monospace; text-transform: uppercase; font-weight: bold; letter-spacing: 1px; transition: color 0.2s; }
        .btn-toggle-pass:hover { color: var(--highlight); }
        .password-reqs { text-align: left; font-size: 0.7rem; margin-bottom: 15px; padding: 10px; background: rgba(255,255,255,0.05); border-radius: 4px; }
        .req-item { display: block; margin-bottom: 2px; color: #666; transition: 0.2s; }
        .req-item.valid { color: var(--success); } 
        .req-item::before { content: '• '; }
        .req-item.valid::before { content: '✓ '; }

        .profile-grid { display: grid; grid-template-columns: repeat(auto-fill, minmax(140px, 1fr)); gap: 15px; margin-top: 20px; }
        .profile-movie-item { background: rgba(255,255,255,0.02); padding: 15px; border: 1px solid #222; transition: 0.2s; position: relative; overflow: hidden; cursor: pointer; }
        .profile-movie-item:hover { background: rgba(255,255,255,0.05); border-color: #fff; }
        .profile-movie-item:hover::after { content: ''; position: absolute; top: 0; left: 0; width: 100%; height: 2px; background: var(--highlight); }

        .rating-stars { display: flex; justify-content: center; gap: 10px; margin: 20px 0; cursor: pointer; }
        .star-icon { font-size: 2rem; color: #222; transition: 0.2s; }
        .star-icon:hover, .star-icon.active { color: var(--highlight); } 
        .rating-textarea { width: 100%; background: #000; border: 1px solid #333; color: #fff; font-family: 'Space Mono'; padding: 10px; font-size: 0.8rem; resize: vertical; min-height: 80px; margin-bottom: 20px; outline: none; transition: 0.2s; }
        .rating-textarea:focus { border-color: var(--highlight); }
        .sorting-anim { font-size: 1.5rem; font-weight: normal; text-align: center; color: #fff; letter-spacing: 3px; background: #000; padding: 20px 40px; border-top: 1px solid #333; border-bottom: 1px solid #333; }
        .tab-header { display: flex; gap: 20px; margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .tab-btn { background: none; border: none; color: #666; font-family: 'Space Mono'; font-size: 0.8rem; cursor: pointer; text-transform: uppercase; letter-spacing: 1px; transition: 0.2s; padding: 0; }
        .tab-btn:hover { color: #fff; }
        .tab-btn.active { color: var(--highlight); font-weight: bold; }
        .stat-box { background: #050505; padding: 20px; border: 1px solid #222; margin-bottom: 10px; }
        .stat-label { color: #555; font-size: 0.7rem; margin-bottom: 5px; text-transform: uppercase; }
        .stat-value { font-size: 2.5rem; font-weight: bold; color: #fff; line-height: 1; }
        
        .search-result-item { display: flex; justify-content: space-between; align-items: center; background: #111; border: 1px solid #333; padding: 10px; margin-bottom: 10px; cursor: pointer; transition: 0.2s; }
        .search-result-item:hover { border-color: var(--highlight); background: #1a1a1a; }
        .search-btn-action { background: #222; color: #fff; border: none; padding: 5px 10px; font-size: 0.7rem; cursor: pointer; }
        .search-empty { color: #666; text-align: center; margin-top: 20px; font-style: italic; }
        
        /* --- ESTILOS DE AVATAR --- */
        .avatar-base { border-radius: 50%; object-fit: cover; border: 1px solid #333; flex-shrink: 0; }
        .user-avatar-mini { width: 40px; height: 40px; }
        .avatar-large { width: 95px; height: 95px; border: 2px solid #333; margin-right: 15px; font-size: 2.5rem; }
        .avatar-grid { display: flex; gap: 15px; margin-top: 15px; margin-bottom: 20px; flex-wrap: wrap; }
        .avatar-option { width: 60px; height: 60px; border: 2px solid #222; cursor: pointer; transition: 0.2s; opacity: 0.7; }
        .avatar-option:hover { border-color: #fff; opacity: 1; }
        .avatar-option.selected { border-color: var(--highlight); transform: scale(1.1); opacity: 1; box-shadow: 0 0 10px var(--highlight); }
        .avatar-letter { display: flex; align-items: center; justify-content: center; color: #fff; font-weight: bold; font-family: sans-serif; text-shadow: 0 1px 2px rgba(0,0,0,0.5); }
        .search-avatar { width: 35px; height: 35px; margin-right: 15px; font-size: 0.9rem; }

        /* --- ESTILOS DE COLEÇÕES --- */
        .collection-card { background: linear-gradient(45deg, #111, #0a0a0a); border: 1px solid #333; padding: 20px; margin-bottom: 15px; position: relative; overflow: hidden; transition: 0.3s; cursor: pointer; }
        .collection-card:hover { border-color: #666; background: #161616; }
        .collection-card.completed { border-color: var(--success); box-shadow: 0 0 15px rgba(0, 230, 118, 0.1); }
        .col-header { display: flex; justify-content: space-between; align-items: flex-start; margin-bottom: 15px; }
        .col-title { color: #fff; font-size: 1rem; font-weight: bold; letter-spacing: 1px; text-transform: uppercase; margin: 0; }
        .col-desc { color: #666; font-size: 0.7rem; margin-top: 5px; }
        .progress-track { background: #222; height: 6px; width: 100%; border-radius: 3px; overflow: hidden; margin-top: 10px; }
        .progress-fill { height: 100%; background: var(--highlight); width: 0%; transition: width 0.5s ease; }
        .collection-card.completed .progress-fill { background: var(--success); }
        .col-status { font-size: 0.65rem; color: #888; margin-top: 8px; display: flex; justify-content: space-between; }
        .col-status span.done { color: var(--success); font-weight: bold; }
        .avatar-separator { width: 100%; color: #666; font-size: 0.65rem; margin: 15px 0 5px 0; border-bottom: 1px solid #333; padding-bottom: 5px; }

        /* --- ESTILOS DE STACK --- */
        .reward-stack { display: flex; align-items: center; }
        .reward-item { position: relative; border-radius: 50%; border: 1px solid #333; overflow: hidden; background: #000; box-shadow: 2px 0 5px rgba(0,0,0,0.5); transition: 0.2s; }
        .reward-item img { width: 100%; height: 100%; object-fit: cover; filter: grayscale(100%); }
        .reward-item.unlocked img { filter: none; } 
        .reward-item.counter { display: flex; align-items: center; justify-content: center; background: #222; color: #fff; font-size: 0.6rem; font-weight: bold; border: 1px solid #444; }
        .lock-overlay-mini { position: absolute; inset: 0; display: flex; align-items: center; justify-content: center; font-size: 0.6rem; background: rgba(0,0,0,0.5); }
        
        .reward-stack.small .reward-item { width: 30px; height: 30px; margin-left: -8px; }
        .reward-stack.small .reward-item:first-child { margin-left: 0; }
        
        .reward-stack.large .reward-item { width: 60px; height: 60px; margin-left: -15px; border-width: 2px; font-size: 1rem; }
        .reward-stack.large .reward-item:first-child { margin-left: 0; }
        .reward-stack.large .lock-overlay-mini { font-size: 1.2rem; }

        /* --- DETALHE --- */
        .col-detail-header { border-bottom: 1px solid #333; padding-bottom: 15px; margin-bottom: 20px; }
        .col-detail-title { font-size: 1.5rem; color: #fff; text-transform: uppercase; margin: 0; }
        .col-detail-desc { color: #888; font-size: 0.8rem; margin-top: 5px; }
        .col-movie-list { margin-bottom: 20px; }
        .col-movie-item { padding: 12px; border-bottom: 1px solid #222; display: flex; justify-content: space-between; align-items: center; color: #666; }
        .col-movie-item.watched { color: #fff; }
        .col-movie-item.watched::after { content: '✓'; color: var(--success); font-weight: bold; }
        .col-rewards-sec { background: #111; padding: 15px; border: 1px solid #333; text-align: center; }
        .col-rewards-title { font-size: 0.7rem; color: #666; margin-bottom: 10px; text-transform: uppercase; letter-spacing: 2px; }
        .col-rewards-center { display: flex; justify-content: center; flex-wrap: wrap; gap: 10px; }
        
        .col-level-block { margin-bottom: 15px; border-bottom: 1px solid #222; padding-bottom: 10px; }
        .col-level-block:last-child { border-bottom: none; }
        .level-status { font-size: 0.65rem; color: #555; margin-bottom: 5px; text-transform: uppercase; }
        .level-status.done { color: var(--success); }

        /* NOVOS ESTILOS: User Code & Friend Button */
        .user-code-box { display: flex; align-items: center; margin-top: 5px; gap: 10px; }
        .user-code-text { background: #111; border: 1px solid #333; color: #666; padding: 2px 8px; font-size: 0.8rem; border-radius: 4px; letter-spacing: 1px; }
        .btn-copy-code { background: transparent; border: 1px solid #444; color: #666; border-radius: 4px; width: 25px; height: 25px; display: flex; align-items: center; justify-content: center; cursor: pointer; font-size: 0.8rem; transition: 0.2s; }
        .btn-copy-code:hover { border-color: #fff; color: #fff; }
        .btn-copy-code.copied { border-color: var(--success); color: var(--success); }
        .btn-friend-add:hover { background: var(--pink) !important; color: #fff !important; }

        @keyframes slideUp { from { transform: translateY(20px); opacity: 0; } to { transform: translateY(0); opacity: 1; } }
        @keyframes fadeIn { from { opacity: 0; } to { opacity: 1; } }
        @media (max-width: 600px) { .big-title { font-size: 2rem; } .card-title { font-size: 1.5rem; } .movie-card { padding: 30px; } }
    </style>
</head>
<body>
    <div id="root"></div>
    <script type="text/babel" data-type="module">
        // --- IMPORTAÇÕES DOS NOVOS MÓDULOS (ABSOLUTOS) ---
        import FriendAction from '/src/components/FriendAction.js';
        import AddFriends from '/src/components/FriendAdd.js';
        import SocialFeed from '/src/components/SocialFeed.js'; // NOVO IMPORT
        import RewardStack from '/src/components/RewardStack.js';
        import DashPlayer from '/src/components/DashPlayer.js';
        import RatingCard from '/src/components/RatingCard.js';
        import CollectionCard from '/src/components/CollectionCard.js';
        import CollectionDetail from '/src/components/CollectionDetail.js';
        import LoginModal from '/src/components/LoginModal.js';
        import UserProfile from '/src/components/UserProfile.js';

        import { Api } from '/src/api.js';
        import { BUCKET_URL, AVATAR_COUNT, AVATAR_COLORS, getAvatarUI } from '/src/utils.js';

        // --- COMPONENTES INTERNOS ---
        
        const App = () => {
            const [phase, setPhase] = React.useState('home'); 
            const [fullCatalog, setFullCatalog] = React.useState(null);
            const [collections, setCollections] = React.useState(null);
            const [currentMovie, setCurrentMovie] = React.useState(null);
            const [sortText, setSortText] = React.useState("");
            const [user, setUser] = React.useState(null);
            const [showLogin, setShowLogin] = React.useState(false);
            const [showProfile, setShowProfile] = React.useState(false); 
            const [showRating, setShowRating] = React.useState(false); 
            const [showLoginWarning, setShowLoginWarning] = React.useState(false); 
            const [showSocial, setShowSocial] = React.useState(false); // NOVO ESTADO
            const [watchedList, setWatchedList] = React.useState([]);
            const [reviewsList, setReviewsList] = React.useState([]);
            const [energy, setEnergy] = React.useState(3);
            const [energyTs, setEnergyTs] = React.useState(0);

            React.useEffect(() => {
                fetch(`${BUCKET_URL}/shorts.json?t=${new Date().getTime()}`).then(r=>r.json()).then(data => {
                    const { _collections, ...movies } = data;
                    setFullCatalog(movies); setCollections(_collections);
                }).catch(console.error);
                const u = Api.getCurrentUser(); setUser(u);
                if(u) syncProfile(u.email);
            }, []);

            const syncProfile = async (email) => {
                const data = await Api.getProfile(email);
                if(data.username) { 
                    Api.updateLocalUser(data.username, data.avatar, data.color); 
                    setUser(prev => ({ ...prev, username: data.username, avatar: data.avatar || 0, color: data.color || '#333', friend_code: data.friend_code })); 
                }
                setWatchedList(data.watched || []); setReviewsList(data.reviews || []);
                setEnergy(data.energy); setEnergyTs(data.energy_ts);
            };

            const handleLogout = () => { Api.signOut(); setUser(null); setShowProfile(false); setWatchedList([]); setReviewsList([]); };
            const refreshUser = () => { const u = Api.getCurrentUser(); setUser(u); if(u) syncProfile(u.email); };

            const startSort = () => {
                if (!fullCatalog) return;
                if (!user) { setShowLoginWarning(true); return; } 
                if (energy <= 0) { alert("Sem energia! Aguarde recarregar."); return; }
                setPhase('sorting');
                const titles = Object.values(fullCatalog).map(m => m.titulo);
                let steps = 0;
                const interval = setInterval(() => {
                    setSortText(titles[Math.floor(Math.random() * titles.length)]);
                    steps++;
                    if (steps > 20) { clearInterval(interval); finishSort(); }
                }, 100);
            };

            const finishSort = async () => {
                let ids = Object.keys(fullCatalog).filter(id => !watchedList.includes(id));
                if (ids.length === 0) ids = Object.keys(fullCatalog); 
                const randomId = ids[Math.floor(Math.random() * ids.length)];
                try {
                    const res = await Api.saveMovie(user.email, randomId);
                    setEnergy(res.energy);
                    prepareMovie(randomId);
                    const newList = [...watchedList, randomId];
                    setWatchedList(newList);
                } catch(e) {
                    alert("Você não tem energia suficiente!");
                    setPhase('home');
                }
            };
            
            const prepareMovie = (movieId) => {
                 const movieData = fullCatalog[movieId];
                 const slug = movieId.toLowerCase().replace(/ /g, "_");
                 setCurrentMovie({ id: movieId, ...movieData, videoUrl: `${BUCKET_URL}/videos/${slug}/playlist.mpd` });
                 setPhase('popup'); setShowRating(false);
            };
            
            const handleMovieEnd = () => { setShowRating(true); };
            const handleCloseRating = () => { setShowRating(false); setPhase('home'); setCurrentMovie(null); refreshUser(); };
            const handleReset = () => { setPhase('home'); setCurrentMovie(null); setShowRating(false); };

            let videoClass = "video-background";
            if (phase === 'popup' || showRating) videoClass += " dimmed"; 
            if (phase === 'playing' && !showRating) videoClass += " active";

            const nextRecharge = new Date((energyTs + (6*3600)) * 1000);
            const hoursLeft = energy < 3 ? Math.ceil((nextRecharge - new Date()) / (1000*3600)) + 'h' : '';
            const showUI = phase !== 'playing'; 

            return (
                <React.Fragment>
                    <div className={videoClass}>
                        {currentMovie && <DashPlayer url={currentMovie.videoUrl} isPlaying={phase === 'playing' && !showRating} startAt={currentMovie.capaSeconds || 0} enableControls={phase === 'playing'} onEnded={handleMovieEnd} />}
                    </div>
                    
                    {user && showUI && (
                        <div className="energy-fixed">
                            {[1,2,3].map(i => <span key={i} className={`energy-bar ${energy >= i ? 'active' : ''}`}></span>)}
                            {energy < 3 && <span className="energy-timer">{hoursLeft}</span>}
                        </div>
                    )}

                    {showUI && (
                        <div className="user-bar">
                            {user ? (
                                <React.Fragment>
                                    <button className="btn-login" onClick={() => setShowSocial(true)} style={{border:'1px solid #666', color:'#ccc'}}>SOCIAL</button>
                                    <div className="user-info" onClick={() => setShowProfile(true)}>
                                        {user.username ? user.username.toUpperCase() : user.email.split('@')[0]}
                                    </div>
                                </React.Fragment>
                            ) : (
                                <button className="btn-login" onClick={() => setShowLogin(true)}>LOGIN</button>
                            )}
                        </div>
                    )}

                    {showSocial && <SocialFeed user={user} catalog={fullCatalog} onClose={() => setShowSocial(false)} />}

                    {showLoginWarning && (
                        <div className="auth-modal">
                            <div className="auth-box" style={{textAlign:'center'}}>
                                <button className="btn-close-box btn-close-absolute" onClick={() => setShowLoginWarning(false)}>✕</button>
                                <h2 style={{margin:'15px 0', color:'#fff'}}>PRECISA DE ENERGIA</h2>
                                <p style={{color:'#888', fontSize:'0.9rem', marginBottom:20}}>Para sortear filmes e ganhar recompensas, você precisa entrar na sua conta.</p>
                                <button className="btn-main" onClick={() => { setShowLoginWarning(false); setShowLogin(true); }}>FAZER LOGIN</button>
                            </div>
                        </div>
                    )}

                    {showLogin && <LoginModal onClose={() => setShowLogin(false)} onLoginSuccess={refreshUser} />}
                    
                    {showProfile && user && (
                        <UserProfile 
                            user={user} watchedList={watchedList} reviewsList={reviewsList} catalog={fullCatalog} collections={collections}
                            onClose={() => setShowProfile(false)} onLogout={handleLogout} onSelectMovie={(id) => { prepareMovie(id); setShowProfile(false); }} onUpdateUser={refreshUser} 
                        />
                    )}

                    {showRating && currentMovie && <RatingCard movie={currentMovie} user={user} onClose={handleCloseRating} />}
                    
                    {phase === 'playing' && !showRating && (
                        <button className="btn-finish" onClick={handleMovieEnd}>ENCERRAR SESSÃO</button>
                    )}

                    {showUI && phase !== 'home' && !showRating && <button className="btn-back-corner" onClick={handleReset}>MENU</button>}
                    
                    <div className="ui-layer">
                        {phase === 'home' && (
                            <div className="sort-container"><div className="big-title">SORT A SHORT</div><br/><button className="btn-main btn-sort" onClick={startSort} disabled={!fullCatalog}>{fullCatalog ? "SORTEAR" : "..."}</button></div>
                        )}
                        {phase === 'sorting' && <div className="sorting-anim">{sortText}</div>}
                        {phase === 'popup' && currentMovie && !showRating && (
                            <div className="movie-card"><div style={{fontSize: '0.7rem', color: '#cc0000', marginBottom: 15, letterSpacing: 2, fontWeight:'bold'}}>● SELEÇÃO</div><h2 className="card-title">{currentMovie.titulo}</h2><span className="card-meta">{currentMovie.ano} — {currentMovie.diretor}</span><div className="card-desc">{currentMovie.descricao || "..."}</div><button className="btn-main" onClick={() => setPhase('playing')}>ASSISTIR</button></div>
                        )}
                    </div>
                </React.Fragment>
            );
        };

        const root = ReactDOM.createRoot(document.getElementById('root'));
        root.render(React.createElement(App));
    </script>
</body>
</html>